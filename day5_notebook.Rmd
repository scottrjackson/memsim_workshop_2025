---
title: "Data Simulation & Hierarchical Models: Day 5"
date: 2025-08-15
---

# Logistics

  - Updates, revisions

# Agenda

  - review, questions
  - new data: from London
  - summary table tips using `dplyr`
  - testing contrasts with the `multcomp` and `lmerTest` packages
  - full simulation example with London's data
    - simple coefficients
    - random intercept and slopes by subject

# Review, questions

  - 

# Load packages

```{r}
library(tidyverse)
library(lme4)
library(lmerTest)
library(multcomp)
```


# A little exploration of London's data

```{r}
london <- read_csv("nat_similarity_lex.csv")
colnames(london)
xtabs(~ Accuracy, london)

length(unique(london$subject_id))
length(unique(london$target))

london |> group_by(repetition, related) |> summarize(count = n())
london |> group_by(repetition, related, subject_id) |> summarize(count = n()) |>
  summary()

london |> group_by(repetition, related, subject_id) |> 
  summarize(count = n(), meanRT = mean(logRT)) |>
  arrange(meanRT)

london |> group_by(subject_id, repetition, related) |> 
  summarize(count = n())

london |> group_by(subject_id, repetition, related) |> 
  summarize(count = n()) |> summarize(count = n()) |> summarize(count = n())

london |> group_by(subject_id, repetition, related) |> 
  summarize(count = n()) |> ungroup() |> 
  group_by(subject_id) |> summarize(count = n()) |> summary()

ggplot(london, aes(RT)) + geom_histogram()
ggplot(london, aes(logRT)) + geom_histogram()

```


# Contrasts

```{r}
london_lm <- lm(logRT ~ 1 + repetition * related, data = london)
summary(london_lm)

london$related <- relevel(as.factor(london$related), "unrelated")
london$repetition <- relevel(as.factor(london$repetition), "none")

summary(london)

london_lm <- lm(logRT ~ 1 + repetition * related, data = london)
summary(london_lm)

```



| conditions | unrelated  | related    |
|:---        | ---:       | ---:       |
| none       | 0, 0, 0, 0 | 0, 0, 1, 0 |
| hidden     | 0, 1, 0, 0 | 0, 1, 1, 1 |


```{r, eval = FALSE}
test_contrasts <- rbind(c(0, 0, -1, 0),
                        c(0, 0, -1, -1),
                        c(0, 0, -1, -0.5))
rownames(test_contrasts) <- c("relatedness for none condition",
                              "relatedness for hidden condition",
                              "average relatedness across repetition")
print(test_contrasts)
# from lmerTest
# contest1D(london_lm, test_contrasts)

# from multcomp
summary(glht(london_lm, linfct = test_contrasts))
```

Mixed-effect

```{r}
london_lmer1a <- lmer(logRT ~ 1 + repetition * related + (1|subject_id), 
                      data = london)
summary(london_lmer1a)

london_lmer1b <- lmer(logRT ~ 1 + repetition * related + (1 + related|subject_id), 
                      data = london)

summary(london_lmer1b)

# extract some contrasts
summary(glht(london_lmer1b, linfct = test_contrasts))
contest1D(london_lmer1b, test_contrasts[3, ])

london_lmer1c <- lmer(logRT ~ 1 + repetition * related + 
                        (1 + repetition + related|subject_id), 
                      data = london)

summary(london_lmer1c)

london_lmer1d <- lmer(logRT ~ 1 + repetition * related + 
                        (1 + repetition + related|subject_id) +
                        (1 | target), 
                      data = london)
summary(london_lmer1d)
london_lmer1e <- lmer(logRT ~ 1 + repetition * related + 
                        (1 + repetition + related|subject_id) +
                        (1 + related| target), 
                      data = london)
summary(london_lmer1e)

london_lmer1b_ML <- update(london_lmer1b, REML = FALSE)
london_lmer1c_ML <- update(london_lmer1c, REML = FALSE)
(AIC(london_lmer1b_ML))
(AIC(london_lmer1c_ML))
anova(london_lmer1c_ML, london_lmer1b_ML)


london_lmer1d_ML <- update(london_lmer1d, REML = FALSE)
london_lmer1e_ML <- update(london_lmer1e, REML = FALSE)
(AIC(london_lmer1d_ML))
(AIC(london_lmer1e_ML))
anova(london_lmer1d_ML, london_lmer1e_ML)

```



# Big simulation

```{r}
summary(london_lmer1d)$coef

intercept <- 6.50
reference <- 0
related_effect <- -0.0167
hidden_effect <- 0.0277
related_hidden_interaction <- -0.0174
rmse <- 0.24

n_per_condition <- 600
london_design <- expand_grid(related = c("unrelated", "related"),
                             repetition = c("none", "hidden"))
london |> group_by(related, repetition) |> summarize()

slope_matrix <- london_design

slope_matrix$slope <- c(reference, 
                        hidden_effect, 
                        related_effect, 
                        sum(related_effect, hidden_effect,  related_hidden_interaction))

slope_matrix
slope_matrix$intercept <- intercept

slope_matrix <- mutate(slope_matrix, prediction = intercept + slope)
slope_matrix

data_grid <- expand_grid(related = c("unrelated", "related"),
                         repetition = c("none", "hidden"),
                         obs = 1:600)
nrow(data_grid)

sim_data <- full_join(slope_matrix, data_grid)
nrow(sim_data)
head(sim_data)

sim_data$sim_logRT <- sim_data$prediction + rnorm(nrow(sim_data), mean = 0, sd = rmse)

sim_lm <- lm(sim_logRT ~ 1 + repetition * related, sim_data)
summary(glht(sim_lm, linfct = test_contrasts))

```

```{r}
set.seed(42)
rnorm(5)



```




