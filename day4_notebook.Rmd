---
title: "Data Simulation & Hierarchical Models: Day 4"
date: 2025-08-14
---

# Review and questions

- Questions?
- Scott's homework: checking out the `contrast` package

# Outline for today

- Generate a random effect
- Use `lmer()` to fit the model
- Practice using `lmer()` on Carmen's data
- Interpreting random effects
- Comparing models with different random effects
- Practice: London's data

# Loading packages

```{r}
library(tidyverse)
library(lme4)
library(lmerTest)
library(HistData)
```

# Recapping simulation from a simple linear model

```{r}
galton_fit <- lm(child ~ 1 + parent, Galton)
summary(galton_fit)
(parent_mean <- mean(Galton$parent))
(parent_sd <- sd(Galton$parent))

intercept <- 24
slope <- 0.6
rmse <- 2.25

n_fake <- 1000
fake_data <- data.frame(parent = rnorm(n_fake, mean = 68, sd = 1.8))
fake_data$child <- intercept + slope * fake_data$parent + rnorm(n_fake, mean = 0, sd = rmse)

summary(lm(child ~ 1 + parent, fake_data))

generate_height_data <- function(n, intercept, slope, rmse,
                                 parent_mean, parent_sd) {
  fake_data <- data.frame(parent = rnorm(n, mean = parent_mean, sd = parent_sd))
  fake_data$child <- intercept + slope * fake_data$parent + rnorm(n, mean = 0, sd = rmse)
  
  return(fake_data)
}

fake_data2 <- generate_height_data(1000, 25, 0.6, 2.2, 68, 1.8)

summary(lm(child ~ 1 + parent, fake_data2))

```

Now let's do random effects

```{r}
n_countries <- 25

(country_parent_means <- rnorm(n = n_countries, mean = 68, sd = 2))
(country_intercepts <- rnorm(n = n_countries, mean = 24, sd = 3))

n_per_country <- 40
full_height_data <- data.frame(parent = NULL, child = NULL, country = NULL)
for(country in 1:n_countries) {
  
  country_data <- generate_height_data(n_per_country,
                                       intercept = country_intercepts[country],
                                       slope = slope,
                                       rmse = rmse,
                                       parent_mean = country_parent_means[country],
                                       parent_sd = 2)
  country_data$country <- country
  full_height_data <- bind_rows(full_height_data, country_data)
  
}

head(full_height_data)
full_height_data |> group_by(country) |> summarize(count = n())

summarize(group_by(full_height_data, country), count = n())

cell_means <- full_height_data |> group_by(country) |> 
  summarize(mean_parent = mean(parent))
cell_means$theoretical <- country_parent_means
head(cell_means)

height_lmer <- lmer(child ~ 1 + parent + (1|country), data = full_height_data)
summary(height_lmer)

height_lmer2 <- lmer(child ~ 1 + parent + (1 + parent|country), data = full_height_data)

height_lmer2b <- lmer(child ~ 1 + parent + (1|country) + (0 + parent|country), data = full_height_data)

summary(height_lmer2b)

```

Carmen's data

```{r}
carmen <- read_csv("summer25_stat_workshop_Canphon_parti24.csv")
colnames(carmen)

carmen |> group_by(Legality, SLx) |> summarize(count = n())

carmen$logLook <- log(carmen$TotalLook)

ggplot(carmen, aes(Trial, logLook)) + geom_point() + 
  geom_smooth(method = "lm")

carmen$logTrial <- log(carmen$Trial)

carmen_trial_lm <- lm(logLook ~ 1 + logTrial, data = carmen)
summary(carmen_trial_lm)

carmen_trial_lmer1 <- lmer(logLook ~ 1 + logTrial + (1|SubjectID), data = carmen)
summary(carmen_trial_lmer1)

carmen_trial_lmer2 <- lmer(logLook ~ 1 + logTrial + 
                             (1 + logTrial|SubjectID), data = carmen)
summary(carmen_trial_lmer2)

carmen_trial_lmer2b <- lmer(logLook ~ 1 + logTrial + 
                              (1|SubjectID) + 
                              (0 + logTrial|SubjectID), data = carmen)
summary(carmen_trial_lmer2b)


sd(ranef(carmen_trial_lmer1)$SubjectID[, 1])

bysubject_ranefs <- ranef(carmen_trial_lmer2)$SubjectID
head(bysubject_ranefs)

ggplot(bysubject_ranefs, aes(`(Intercept)`, logTrial)) + geom_point()

```


```{r}
carmen_legality_lmer <- lmer(logLook ~ 1 + logTrial + Legality +
                               (1+logTrial|SubjectID), data = carmen)
summary(carmen_legality_lmer)

carmen_legality_lmer2 <- lmer(logLook ~ 1 + logTrial + Legality * preference +
                               (1+logTrial|SubjectID), data = carmen)
summary(carmen_legality_lmer2)
```


```{r}
summary(carmen_trial_lm)$coef
summary(carmen_trial_lmer1)$coef
summary(carmen_trial_lmer2)$coef

sqrt(diag(VarCorr(carmen_trial_lmer1)$SubjectID))
sqrt(diag(VarCorr(carmen_trial_lmer2)$SubjectID))


carmen_trial_lmer1_ML <- update(carmen_trial_lmer1, REML = FALSE)
summary(carmen_trial_lmer1_ML)
carmen_trial_lmer2_ML <- update(carmen_trial_lmer2, REML = FALSE)
summary(carmen_trial_lmer2_ML)

AIC(carmen_trial_lm)
AIC(carmen_trial_lmer1_ML)
AIC(carmen_trial_lmer2_ML)

anova(carmen_trial_lmer2_ML, carmen_trial_lmer1_ML, carmen_trial_lm)
```


```{r}
xtabs(~ Sex, carmen)

carmen_sex_lm1 <- lm(logLook ~ 1 + Sex, data = carmen)
carmen_sex_lmer1 <- lmer(logLook ~ 1 + Sex + (1|SubjectID), data = carmen)
summary(carmen_sex_lm1)
summary(carmen_sex_lmer1)
AIC(carmen_sex_lm1)
AIC(carmen_sex_lmer1)
carmen_subject_lm1 <- lm(logLook ~ 1 + logTrial + SubjectID, data = carmen)
summary(carmen_subject_lm1)
AIC(carmen_subject_lm1)
AIC(carmen_trial_lmer1_ML)

anova(carmen_trial_lmer1_ML, carmen_subject_lm1)

carmen_subject_lm2 <- lm(logLook ~ 1 + logTrial * SubjectID, data = carmen)
summary(carmen_subject_lm2)

```


